# Requirements: Analyze Project Merge/Augment

> **Document**: 01-requirements.md
> **Parent**: [Index](00-index.md)

## Feature Overview

The `analyze_project` tool must be enhanced to detect and preserve an existing `.clinerules/project.md` file. Instead of always generating a fresh document from scratch, it should intelligently merge fresh scan results with the existing file — preserving user customizations while updating auto-detectable toolchain information.

## Functional Requirements

### Must Have

- [ ] **Detect existing file**: Check if `<projectPath>/.clinerules/project.md` exists before generating output
- [ ] **Read existing content**: Parse the existing `project.md` into structured sections when found
- [ ] **Preserve user-edited sections**: Never overwrite sections that are primarily user-customized (Coding Conventions, Special Rules, Git Conventions, Import Conventions, Environment & Dependencies, Agent Automation)
- [ ] **Update auto-detectable sections**: Refresh sections that correspond to auto-detected data (Project Overview name/type, Toolchain, Commands, Project Structure directory layout)
- [ ] **Fill TODO placeholders**: Replace `[TODO: ...]` markers with detected values when available
- [ ] **Generate change log**: Include a change summary at the top of the merged output showing what was updated
- [ ] **Preserve fresh-generation path**: When no existing `project.md` is found, behavior is identical to current implementation
- [ ] **Preserve custom sections**: If the user added entirely new sections not in the template, they must be preserved

### Should Have

- [ ] **Detect user-modified auto-fields**: If a user manually changed an auto-detectable field (e.g., customized the build command), preserve the user's version and note the detected change in the change log
- [ ] **Section ordering**: Maintain the section order from the existing file rather than imposing a new order

### Won't Have (Out of Scope)

- Writing the merged file to disk — the tool returns content, the agent saves it
- Interactive merge conflict resolution
- Diffing at the character level within prose sections
- Support for non-markdown project.md formats

## Technical Requirements

### Compatibility

- Must work with project.md files generated by the current `analyze_project` tool
- Must work with project.md files manually created from the `project-template.md` template
- Must handle project.md files that have been heavily customized (added/removed sections)

### Robustness

- Must handle malformed/partially complete existing project.md files gracefully
- Must not crash if the existing file is empty or has unexpected structure

## Scope Decisions

| Decision                          | Options Considered           | Chosen              | Rationale                                                    |
| --------------------------------- | ---------------------------- | -------------------- | ------------------------------------------------------------ |
| Merge granularity                 | Full rewrite, Section-level, Line-level | Hybrid (line-level within auto sections, section-level for preserve) | Best balance of accuracy for toolchain updates and safety for user content |
| How to classify sections          | Hardcoded list, Heuristic    | Hardcoded classification | Predictable, testable, matches known template structure      |
| Change detection for auto-fields  | Hash comparison, Pattern match | Pattern match against auto-generated format | Simpler, no need to persist hashes, works with any existing file |

## Acceptance Criteria

1. [ ] Running `analyze_project` on a project with no existing `project.md` produces identical output to current behavior
2. [ ] Running `analyze_project` on a project with an existing customized `project.md` preserves all user-edited sections
3. [ ] Running `analyze_project` after adding a new dependency correctly updates the Toolchain section
4. [ ] Running `analyze_project` on a project.md with `[TODO]` placeholders fills them with detected values
5. [ ] The change log accurately lists all modifications made
6. [ ] Custom user-added sections (not in template) are preserved
7. [ ] All existing tests continue to pass
8. [ ] New tests cover merge scenarios with >90% coverage
